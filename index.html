<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Certificate Verification - Newcastle College Ltd</title>

  <style>
 @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
:root {
  --brand:#0067C5;  /* Header True Blue */
  --accent:#00509e;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;
  background:#f5f9ff;color:#012f6b;
  min-height:100vh;display:flex;flex-direction:column
}

/* ===== Header / branding ===== */
header{background:#0067C5;color:#fff;padding:1rem 1.2rem}
.brandbar{
  max-width:1100px;margin:0 auto;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.brand-left{display:flex;align-items:center;gap:12px}
.brand-left img.logo{height:50px;width:auto;display:block}
.brand-title{font-size:1.2rem;font-weight:600;line-height:1.2}
.brand-right img{height:40px;width:auto;display:block;opacity:.95}
.gov-cred{font-size:.9rem;color:#bfe;opacity:.95;margin-top:6px;text-align:center}

/* ===== Main card ===== */
main{
  max-width:900px;margin:1.5rem auto;padding:1.5rem;background:#fff;
  border-radius:10px;box-shadow:0 8px 24px rgba(2,17,55,.06)
}
h1,h2{margin:.25rem 0}
.controls{display:flex;gap:12px;flex-wrap:wrap;margin:1rem 0}
input[type=text]{width:100%;padding:.6rem;border:1.5px solid var(--brand);border-radius:8px}
button{font:inherit}
.primary{background:var(--brand);color:#fff;border:none;padding:.65rem 1rem;border-radius:8px;cursor:pointer}
.ghost{background:#fff;border:1px solid #dbe8ff;color:var(--brand);padding:.5rem .8rem;border-radius:8px;cursor:pointer}
#reader{display:none;margin:1rem auto;max-width:420px;border:3px solid var(--accent);border-radius:12px;overflow:hidden;aspect-ratio:1/1;background:#000}
#status{margin-top:.5rem}
.verified{background:#e6f9ec;border:1px solid #2e7d32;color:#1f5f2f;padding:1rem;border-radius:8px}
.notfound{background:#fff1f1;border:1px solid #c62828;color:#8a1e1e;padding:1rem;border-radius:8px}
#admin-panel{display:none;margin-top:1rem;padding:1rem;border-radius:10px;border:2px dashed #dbe8ff;background:#fff}
table{width:100%;border-collapse:collapse;margin-top:.75rem}
th,td{padding:.5rem;border:1px solid #e6eef8;text-align:left}
th{background:#f3f8ff}
.small{font-size:.9rem}
.muted{color:#556;font-size:.9rem}
.flex{display:flex;gap:.5rem;align-items:center}
.qr-preview img{max-width:180px;border-radius:8px;border:1px solid #e6eef8}

/* ===== Footer ===== */
footer{margin-top:auto;background:#1D2E59;color:#fff}
.partners-wrap{max-width:1100px;margin:0 auto;padding:14px 12px}
.partners{
  background:#0c2b57;border-radius:10px;padding:10px;
  display:flex;justify-content:center;align-items:center;
  box-shadow:0 4px 14px rgba(0,0,0,.15)
}
.partners img{display:block;max-width:100%;height:auto}
.copyright{max-width:1100px;margin:0 auto;padding:10px 12px;text-align:center;font-size:.95rem;opacity:.95}

/* ===== Responsive tweaks ===== */
@media (max-width: 768px){
  .brandbar{flex-direction:column;gap:10px}
  .brand-left{justify-content:center;text-align:center}
  .brand-left img.logo{height:44px}
  .brand-title{font-size:1.08rem}
  .brand-right img{height:32px}
}
@media (max-width: 480px){
  .brand-left img.logo{height:38px}
  .brand-title{font-size:1rem}
  .brand-right img{height:28px}
}
</style>

  <!-- QR libraries -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <!-- Header with college logo (left) + UKRLP mark (right) -->
  <header>
    <div class="brandbar">
      <div class="brand-left">
        <img class="logo" src="ncl_logo.png" alt="Newcastle College logo">
        <div class="brand-title">Newcastle College Ltd ‚Äî Certificate Verification</div>
      </div>
      <div class="brand-right">
        <img src="ukrlp.png" alt="UKRLP Verified Provider">
      </div>
    </div>
    <div class="gov-cred">Verified provider ‚Äî UK Register of Learning Providers (UKRLP) &amp; regulated by OFQUAL</div>
  </header>

  <main>
    <h2>Verify Your Qualification</h2>
    <p class="muted">Scan the QR printed on the certificate (or enter the Qualification Number + Name) to verify authenticity.</p>

    <div class="controls">
      <button id="startScan" class="primary">üì∑ Start Scanner</button>
      <button id="stopScan" class="ghost" style="display:none">‚úï Stop Scanner</button>
    </div>

    <div id="reader" aria-hidden="true"></div>

    <form id="verifyForm" autocomplete="off">
      <label class="small">Qualification Number</label>
      <input type="text" id="qualificationNumber" placeholder="e.g. NC-2025-001234" />
      <label class="small" style="margin-top:.5rem">Candidate Name</label>
      <input type="text" id="name" placeholder="e.g. Jane Doe" />
      <div style="margin-top:10px"><button type="submit" class="primary">Verify Certificate</button></div>
    </form>

    <div id="loading" style="display:none;margin-top:.75rem">Checking...</div>
    <div id="status"></div>

    <!-- Admin (hidden by keyboard shortcut) -->
    <div id="admin-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">üîí Admin Panel</h3>
        <div class="flex"><button id="refreshListBtn" class="ghost">üîÑ Refresh</button></div>
      </div>

      <div style="margin-top:.5rem;overflow:auto;max-height:320px">
        <table id="certTable">
          <thead><tr><th>QualificationNumber</th><th>Name</th><th>Level</th><th>AwardedBy</th><th>Year</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h4 style="margin-top:.8rem">Add New Certificate</h4>
      <form id="addCertForm">
        <input name="QualificationNumber" placeholder="Qualification Number" required style="margin-top:.5rem" />
        <input name="Name" placeholder="Name" required style="margin-top:.5rem" />
        <input name="Level" placeholder="Level" style="margin-top:.5rem" />
        <input name="AwardedBy" placeholder="Awarded By" style="margin-top:.5rem" />
        <input name="Year" placeholder="Year" style="margin-top:.5rem" />
        <div style="display:flex;gap:.5rem;margin-top:.6rem">
          <button type="submit" class="primary">Add & Generate QR</button>
          <button type="button" id="hideAdmin" class="ghost">Close</button>
        </div>
      </form>

      <div id="qrCodeContainer" class="qr-preview" style="margin-top:.75rem"></div>
    </div>
  </main>

  <!-- Footer with partner strip -->
  <footer>
    <div class="partners-wrap">
      <div class="partners">
        <img src="partner_strip.png" alt="Accreditations and partner logos">
      </div>
    </div>
    <div class="copyright">¬© Newcastle College Ltd</div>
  </footer>

  <script>
  // =========== CONFIG ===========
  const ADMIN_PASSWORD = 'sex126';
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzB_vRfANEVur2waJsrYSIZAK4lVE9aFA2h4loANrtCWJloLS75HtK2_XtM9vncQgUnfQ/exec';
  // ==============================

  // Local fallback dataset for testing if backend is unreachable
  let usingMock = false;
  const mockRecords = [
    { QualificationNumber: 'NC-2025-001234', Name: 'Jane Doe', Level: 'Level 4 BTEC', AwardedBy: 'Newcastle College Ltd', Year: '2025' },
    { QualificationNumber: 'NC-2025-005678', Name: 'John Smith', Level: 'Level 3 NVQ', AwardedBy: 'Newcastle College Ltd', Year: '2025' }
  ];

  // UI refs
  const readerEl = document.getElementById('reader');
  const startBtn = document.getElementById('startScan');
  const stopBtn = document.getElementById('stopScan');
  const loadingEl = document.getElementById('loading');
  const statusEl = document.getElementById('status');

  // Helpers
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])) }
  function textEqual(a,b){ return String(a||'').trim().toLowerCase() === String(b||'').trim().toLowerCase() }

  // CORS-safe fetch to Apps Script: use text/plain to avoid preflight
  function postToScript(payload, timeoutMs = 8000){
    return new Promise((resolve, reject) => {
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), timeoutMs);
      fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
        signal: controller.signal
      }).then(r=>{ clearTimeout(timer); resolve(r); }).catch(err=>{ clearTimeout(timer); reject(err); });
    });
  }

  async function backendList(){
    try{
      const res = await postToScript({ action: 'list' });
      if(!res.ok) throw new Error('Bad response');
      const data = await res.json();
      if(!data || !Array.isArray(data.records)) throw new Error('Unexpected backend format');
      usingMock = false;
      return data.records;
    }catch(err){
      console.warn('Backend list failed, using mock:', err);
      usingMock = true;
      return mockRecords.slice();
    }
  }

  async function backendAdd(record){
    try{
      const res = await postToScript(Object.assign({ action: 'add' }, record));
      if(!res.ok) throw new Error('Bad response');
      const data = await res.json();
      if(data && data.success) return { ok:true };
      throw new Error(data && data.error ? data.error : 'Add failed');
    }catch(err){
      console.warn('Backend add failed, storing locally:', err);
      mockRecords.push(record);
      usingMock = true;
      return { ok:false, local:true };
    }
  }

  async function backendDelete(record){
    try{
      const res = await postToScript(Object.assign({ action: 'delete' }, record));
      if(!res.ok) throw new Error('Bad response');
      const data = await res.json();
      if(data && data.success) return { ok:true };
      throw new Error(data && data.error ? data.error : 'Delete failed');
    }catch(err){
      console.warn('Backend delete failed, removing locally:', err);
      const idx = mockRecords.findIndex(r => r.QualificationNumber === record.QualificationNumber && r.Name === record.Name);
      if(idx > -1) mockRecords.splice(idx, 1);
      usingMock = true;
      return { ok:false, local:true };
    }
  }

  // ===== Verification UI =====
  function renderVerified(rec){
    statusEl.innerHTML = `<div class="verified">‚úÖ <strong>VERIFIED</strong><br>
      <b>Name:</b> ${escapeHtml(rec.Name)}<br>
      <b>Qualification:</b> ${escapeHtml(rec.QualificationNumber)}<br>
      <b>Level:</b> ${escapeHtml(rec.Level||'')}<br>
      <b>Awarded By:</b> ${escapeHtml(rec.AwardedBy||'')}<br>
      <b>Year:</b> ${escapeHtml(rec.Year||'')}
      </div>`;
  }
  function renderNotFound(){
    statusEl.innerHTML = `<div class="notfound">‚ùå <strong>NOT FOUND</strong><br>The qualification number or candidate name appears invalid or unregistered.</div>`;
  }

  document.getElementById('verifyForm').addEventListener('submit', async (ev)=>{ ev.preventDefault(); await verifyQualification(); });

  async function verifyQualification(){
    const qual = document.getElementById('qualificationNumber').value.trim();
    const name = document.getElementById('name').value.trim();
    if(!qual || !name) return;
    loadingEl.style.display = 'block';
    statusEl.innerHTML = '';
    const records = await backendList();
    loadingEl.style.display = 'none';
    const found = records.find(r => textEqual(r.QualificationNumber, qual) && textEqual(r.Name, name));
    if(found) renderVerified(found); else renderNotFound();
  }

  // Auto-verify if ?cert=ID present
  function getQueryParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  async function autoVerifyFromQuery(){
    const certId = getQueryParam('cert') || getQueryParam('q') || getQueryParam('id');
    if(!certId) return;
    loadingEl.style.display = 'block';
    const records = await backendList();
    loadingEl.style.display = 'none';
    const found = records.find(r => textEqual(r.QualificationNumber, certId));
    if(found){
      document.getElementById('qualificationNumber').value = found.QualificationNumber;
      document.getElementById('name').value = found.Name;
      renderVerified(found);
    } else {
      renderNotFound();
    }
  }

  // ===== Scanner =====
  let scanner = null;
  async function startScanner(){
    startBtn.disabled = true;
    stopBtn.style.display = 'inline-block';
    readerEl.style.display = 'block';
    if(!window.Html5Qrcode) { startBtn.disabled=false; return; }
    if(scanner) return;
    scanner = new Html5Qrcode('reader');
    try{
      await scanner.start({ facingMode:'environment' }, { fps: 10, qrbox: 250 }, onScanSuccess, ()=>{} );
    }catch(err){
      console.error('Camera error', err); stopScanner();
    }
  }

  function onScanSuccess(decodedText){
    try{
      const t = String(decodedText).trim();
      if( t.startsWith('http://') || t.startsWith('https://') ){
        window.location.href = t; return;
      }
    }catch(e){}
    let qual = '', fullName = '';
    try{
      const payload = String(decodedText).trim();
      if(payload.startsWith('{')){
        const obj = JSON.parse(payload);
        qual = obj.qualificationNumber || obj.QualificationNumber || '';
        fullName = obj.name || obj.Name || '';
      } else {
        const parts = payload.split('|');
        qual = parts[0] || '';
        fullName = parts.slice(1).join('|') || '';
      }
    }catch(e){
      const parts = String(decodedText).split('|');
      qual = parts[0] || '';
      fullName = parts.slice(1).join('|') || '';
    }
    if(qual && fullName){
      document.getElementById('qualificationNumber').value = qual;
      document.getElementById('name').value = fullName;
      verifyQualification();
      stopScanner();
    } else if(qual){
      document.getElementById('qualificationNumber').value = qual;
      (async ()=>{
        loadingEl.style.display = 'block';
        const records = await backendList();
        loadingEl.style.display = 'none';
        const found = records.find(r=>textEqual(r.QualificationNumber, qual));
        if(found){ document.getElementById('name').value = found.Name; renderVerified(found); }
        else { renderNotFound(); }
      })();
      stopScanner();
    }
  }

  function stopScanner(){
    if(!scanner){
      readerEl.style.display = 'none'; stopBtn.style.display = 'none'; startBtn.disabled = false; return;
    }
    scanner.stop().then(()=>{
      scanner.clear(); scanner = null;
      readerEl.style.display='none'; stopBtn.style.display='none'; startBtn.disabled=false;
    }).catch(()=>{
      scanner=null; readerEl.style.display='none'; stopBtn.style.display='none'; startBtn.disabled=false;
    });
  }

  stopBtn.addEventListener('click', stopScanner);
  startBtn.addEventListener('click', startScanner);

  // ===== Admin Panel =====
  document.addEventListener('keydown', async (e)=>{
    if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='a'){
      e.preventDefault();
      const panel = document.getElementById('admin-panel');
      if(panel.style.display === 'block'){ panel.style.display = 'none'; return; }
      const pass = prompt('Enter admin password:');
      if(pass === ADMIN_PASSWORD){ panel.style.display = 'block'; await fetchCertificates(); }
      else { alert('Incorrect password'); }
    }
  });

  async function fetchCertificates(){
    const tbody = document.querySelector('#certTable tbody');
    tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
    try{
      const records = await backendList();
      tbody.innerHTML = '';
      records.forEach(r=>{
        const tr = document.createElement('tr');
        const q = escapeHtml(r.QualificationNumber||'');
        const n = escapeHtml(r.Name||'');
        const l = escapeHtml(r.Level||'');
        const a = escapeHtml(r.AwardedBy||'');
        const y = escapeHtml(r.Year||'');
        tr.innerHTML = `<td>${q}</td><td>${n}</td><td>${l}</td><td>${a}</td><td>${y}</td><td></td>`;
        const actionsCell = tr.querySelector('td:last-child');
        const delBtn = document.createElement('button'); delBtn.textContent='üóëÔ∏è'; delBtn.className='ghost';
        delBtn.addEventListener('click', ()=>deleteCertificate(r.QualificationNumber, r.Name));
        const qrBtn = document.createElement('button'); qrBtn.textContent='üì• QR'; qrBtn.className='ghost'; qrBtn.style.marginLeft='8px';
        qrBtn.addEventListener('click', ()=>generateQRCodeForPrinting(r.QualificationNumber));
        actionsCell.appendChild(delBtn); actionsCell.appendChild(qrBtn);
        tbody.appendChild(tr);
      });
    }catch(err){
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="6">Error loading records.</td></tr>';
    }
  }

  async function deleteCertificate(q,n){
    if(!confirm(`Delete ${n} (${q})?`)) return;
    const res = await backendDelete({ QualificationNumber: q, Name: n });
    if(res && res.ok){ alert('Deleted'); } else { alert('Removed locally (backend unavailable)'); }
    fetchCertificates();
  }

  // Generate a QR that encodes an absolute verification URL for printing
  function generateQRCodeForPrinting(id){
    const base = `${location.origin}${location.pathname}`;
    const url = `${base}?cert=${encodeURIComponent(id)}`;
    const container = document.getElementById('qrCodeContainer');
    container.innerHTML = '<div class="muted">Generating QR...</div>';
    QRCode.toDataURL(url, { width: 400, margin: 2 }).then(imgUrl => {
      container.innerHTML = `<div class="flex" style="align-items:center">
        <div class="qr-preview"><img src="${imgUrl}" alt="QR for ${escapeHtml(id)}"/></div>
        <div style="margin-left:14px">
          <div><strong>URL encoded in QR:</strong></div>
          <div class="small" style="margin-bottom:8px"><code style="background:#f3f8ff;padding:6px;border-radius:6px;display:inline-block">${escapeHtml(url)}</code></div>
          <div><a class="primary" href="${imgUrl}" download="certificate_qr_${encodeURIComponent(id)}.png" style="display:inline-block;padding:.5rem .75rem;background:var(--brand);color:#fff;border-radius:6px;text-decoration:none">Download PNG</a></div>
        </div>
      </div>`;
    }).catch(err => { container.textContent = 'Error generating QR'; console.error(err); });
  }

  // Boot
  (async ()=>{ await backendList(); await autoVerifyFromQuery(); })();

  /* ====== ADDED: Admin Add/Refresh/Close handlers (prevents form reload) ====== */
  (() => {
    const addForm = document.getElementById('addCertForm');
    if (addForm) {
      addForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // stop page refresh

        const fd = new FormData(addForm);
        const record = {
          QualificationNumber: (fd.get('QualificationNumber') || '').trim(),
          Name: (fd.get('Name') || '').trim(),
          Level: (fd.get('Level') || '').trim(),
          AwardedBy: (fd.get('AwardedBy') || '').trim(),
          Year: (fd.get('Year') || '').trim(),
        };

        if (!record.QualificationNumber || !record.Name) {
          alert('Qualification Number and Name are required.');
          return;
        }

        try {
          const res = await backendAdd(record);
          if (res && res.ok) {
            alert('Certificate added.');
          } else if (res && res.local) {
            alert('Backend unavailable ‚Äî saved locally for now.');
          } else {
            alert('Could not add certificate.');
          }
        } catch (err) {
          console.error(err);
          alert('Unexpected error adding certificate.');
        }

        // Refresh table and show QR for new ID
        try { await fetchCertificates(); } catch (e) { console.error(e); }
        try { generateQRCodeForPrinting(record.QualificationNumber); } catch (e) { console.error(e); }

        addForm.reset();
      });
    }

    const refreshBtn = document.getElementById('refreshListBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', async () => {
        try { await fetchCertificates(); } catch (e) { console.error(e); }
      });
    }

    const hideAdminBtn = document.getElementById('hideAdmin');
    if (hideAdminBtn) {
      hideAdminBtn.addEventListener('click', () => {
        document.getElementById('admin-panel').style.display = 'none';
      });
    }
  })();
  /* ====== /ADDED ====== */
  </script>
</body>
</html>
